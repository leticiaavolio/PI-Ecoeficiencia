USE bd_Ecoeficiencia;

/*Relatório: Pessoas que mais doaram por quantidade*/
SELECT u.nome AS nome_usuario, SUM(dp.quantidade) AS total_doado FROM usuarios u 
JOIN doacao d ON u.idUsuario = d.idUsuario JOIN doacaoProduto dp ON d.idDoacao = dp.idDoacao
GROUP BY u.idUsuario, u.nome ORDER BY total_doado DESC;

/*Relatório: Quantidade total de produtos doados*/
SELECT SUM(dp.quantidade) AS total_quantidade_doada FROM doacaoProduto dp;

/*Relatório: Quantidade de produtos em sobra (estoque)*/
SELECT p.idProduto, p.categorias, p.quantidade AS quantidade_inicial, 
COALESCE(SUM(dp.quantidade), 0) AS quantidade_doada, COALESCE(SUM(tp.quantidade), 0) 
AS quantidade_trocada, (p.quantidade - COALESCE(SUM(dp.quantidade), 0) - COALESCE(SUM(tp.quantidade), 0)) AS sobra
FROM produtos p LEFT JOIN doacaoProduto dp ON p.idProduto = dp.idProduto LEFT JOIN trocaProduto tp ON p.idProduto = tp.idProduto 
GROUP BY p.idProduto, p.categorias, p.quantidade;

/*Relatório: Quantidade total de produtos trocados*/
SELECT COUNT(*) AS total_trocas FROM troca;

/*Relatório: Quantidade de trocas por categoria*/
SELECT p.categorias,COUNT(DISTINCT t.idTroca) AS total_trocas,SUM(tp.quantidade) AS total_itens_trocados
FROM troca t JOIN trocaProduto tp ON t.idTroca = tp.idTroca JOIN produtos p ON tp.idProduto = p.idProduto GROUP BY p.categorias;

/*Relatório de pessoas que mais doaram*/
SELECT u.nome AS nome_usuario, SUM(dp.quantidade) AS total_quantidade_doada
FROM usuarios u JOIN doacao d ON u.idUsuario = d.idUsuario JOIN doacaoProduto dp ON d.idDoacao = dp.idDoacao
GROUP BY u.idUsuario, u.nome ORDER BY total_quantidade_doada DESC;